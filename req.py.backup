import requests
import json
import base64

def encode_image(path: str) -> str:
    with open(path, "rb") as f:
        return base64.b64encode(f.read()).decode("utf-8")

# --- CONFIGURATION ---
OPENROUTER_API_KEY = "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"

# --- INPUT DATA ---
# Replace these with your actual data source
image_url    = "./data/lmms-lab__multimodal-open-r1-8k-verified/train/005171.jpg"
b64_image = encode_image(image_url)
ocr_data     = "title Light Seafoam Coral"
obj_det_data = '["frisbee"]'

# --- THE SYSTEM PROMPT ---
# This contains the logic for the "Reasoning-Ready" description
system_instruction = """
# Role
You are an expert Computer Vision Analyst specializing in granular image description for the creation of multimodal reasoning datasets.

# Instructions
Generate a structured description of the image. Synthesize the visual features with the provided OCR and Object Detection data.
Your output must adhere to the following structure:

## 1. High-Level Summary
Provide a concise 2-sentence overview of the scene.

## 2. Detailed Visual Taxonomy
Describe specific elements: Main Subjects, Object Attributes, State of Action.

## 3. Spatial Topology & Layout
Describe geometry: Relative Positioning (left/right/foreground), Depth, and Occlusion.

## 4. Text & Semantic Integration (OCR Context)
Locate provided OCR text within the scene. Explicitly map text to objects.

## 5. Causal & Contextual Inferences
Describe details that support logical reasoning: Lighting, implied events, relationships.

# Constraints
* Be descriptive but objective.
* If OCR/Object data contradicts visual evidence, prioritize visual evidence but note the discrepancy.
* Aim for high information density.
"""

# --- API REQUEST ---
print("Sending request...")
try:
    response = requests.post(
      url="https://openrouter.ai/api/v1/chat/completions",
      headers={
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json",
      },
      data=json.dumps({
        "model": "google/gemini-2.0-flash-exp:free",
        "messages": [
          { "role": "system", "content": system_instruction },
          {
            "role": "user",
            "content": [
              {
                "type": "text",
                "text": f"**OCR Data:** {ocr_data}\n**Object Detection Data:** {obj_det_data}\n\nPlease generate the description."
              },
              { "type": "image_url",
                "image_url": {
                    "url": f"data:image/jpeg;base64,{b64_image}"
                }
              }
            ]
          }
        ]
      })
    )

    # --- SAVE RAW RESPONSE FOR INSPECTION ---
    output_filename = "debug_response.json"

    with open(output_filename, "w", encoding="utf-8") as f:
        try:
            # Try to parse it as JSON and save it prettified
            response_data = response.json()
            json.dump(response_data, f, indent=4)
            print(f"✅ Full JSON response saved to: {output_filename}")

            # Helper: Print the top-level keys to console so you know what happened immediately
            print(f"Keys found in response: {list(response_data.keys())}")

            # Check if it was actually an error
            if 'error' in response_data:
                print(f"⚠️ API returned an error: {response_data['error']}")

        except json.JSONDecodeError:
            # If the server crashed and returned HTML strings, save that instead
            f.write(response.text)
            print(f"⚠️ Response was not JSON. Raw text saved to: {output_filename}")

except Exception as e:
    print(f"❌ Script failed to run: {e}")
